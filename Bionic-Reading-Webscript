// ==UserScript==
// @name          仿生阅读(Bionic Reading) - Final Version
// @namespace     https://github.com/xigai233/Bionic-Reading-Webscript
// @version       3.0
// @description   默认启动，使用 Ctrl+Alt+O 切换状态。基于非破坏性修改和恢复。
// @author        xigai233
// @match         *://*/*
// @license       MIT
// @icon          https://cdn.icon-icons.com/icons2/869/PNG/64/read_mode_icon-icons.com_68002.png
// @grant         none
// @run-at        document-idle
// ==/UserScript==

(function () {
    'use strict';

    // 默认设置为“启用”状态，并在脚本末尾自动启动一次
    let isEnabled = true;

    // 用于标记被修改节点的属性，存储原始文本
    const ORIGINAL_TEXT_ATTR = 'data-bionic-original';

    // 介词和常用词字典 (保持不变)
    const prepositions = [
        'the', 'and', 'in', 'on', 'at', 'by', 'with', 'about', 'against', 'between', 'into',
        'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down',
        'over', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where',
        'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some'
    ];

    // 判断是否为介词或常用词
    function isPreposition(word) {
        return prepositions.includes(word.toLowerCase());
    }

    // 格式化单词
    function formatWord(word) {
        if (!word) return '';

        const puncBefore = word.match(/^[,\.?!;:'"]+/)?.[0] || '';
        const puncAfter = word.match(/[,\.?!;:'"]+$/)?.[0] || '';
        const cleanWord = word.slice(puncBefore.length, word.length - puncAfter.length);

        if (!cleanWord) return word;

        if (isPreposition(cleanWord)) {
            return `${puncBefore}<b>${cleanWord[0]}</b>${cleanWord.slice(1)}${puncAfter}`;
        }

        let boldLength;
        const wordLength = cleanWord.length;

        if (wordLength <= 2) {
            boldLength = 1;
        } else if (wordLength <= 5) {
            boldLength = 2;
        } else {
            boldLength = Math.min(4, wordLength);
        }

        let boldPart = cleanWord.slice(0, boldLength);
        let restPart = cleanWord.slice(boldLength);

        return `${puncBefore}<b>${boldPart}</b>${restPart}${puncAfter}`;
    }

    // 处理单个文本节点
    function processTextNode(textNode) {
        const parent = textNode.parentElement;
        if (!parent || parent.hasAttribute(ORIGINAL_TEXT_ATTR)) return;

        const originalText = textNode.textContent;
        const words = originalText.split(/(\s+)/);

        let formattedHtml = words.map(part => {
            if (/\s+/.test(part)) {
                return part;
            }
            return formatWord(part);
        }).join('');

        const wrapperSpan = document.createElement('span');
        wrapperSpan.setAttribute(ORIGINAL_TEXT_ATTR, originalText);
        wrapperSpan.innerHTML = formattedHtml;

        textNode.replaceWith(wrapperSpan);
    }

    // 遍历元素的子节点，处理其中的文本节点
    function traverseAndFormatText(node) {
        Array.from(node.childNodes).forEach(child => {
            if (child.nodeType === Node.TEXT_NODE && child.textContent.trim().length > 0) {
                if (child.parentElement && !child.parentElement.hasAttribute(ORIGINAL_TEXT_ATTR)) {
                     processTextNode(child);
                }
            } else if (child.nodeType === Node.ELEMENT_NODE &&
                       child.tagName !== 'SCRIPT' &&
                       child.tagName !== 'STYLE' &&
                       child.tagName !== 'PRE' &&
                       child.tagName !== 'CODE' &&
                       !child.hasAttribute(ORIGINAL_TEXT_ATTR)) {
                traverseAndFormatText(child);
            }
        });
    }

    // 撤销仿生阅读功能 (无刷新恢复)
    function revertBionicReading() {
        const modifiedElements = document.querySelectorAll(`span[${ORIGINAL_TEXT_ATTR}]`);

        modifiedElements.forEach(span => {
            const originalText = span.getAttribute(ORIGINAL_TEXT_ATTR);
            if (originalText !== null) {
                const textNode = document.createTextNode(originalText);
                span.replaceWith(textNode);
            }
        });
    }

    // 应用到整个网页的英文内容
    function applyBionicReading() {
        traverseAndFormatText(document.body);
    }

    // 启用或禁用仿生阅读功能
    function toggleBionicReading() {
        isEnabled = !isEnabled; // 切换状态
        if (isEnabled) {
            applyBionicReading();
            console.log("Bionic Reading 已启用");
        } else {
            revertBionicReading();
            console.log("Bionic Reading 已禁用");
        }
    }

    // 判断操作系统
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;

    // 监听键盘事件：Ctrl + Alt + O
    document.addEventListener('keydown', function (e) {
        // 检查是否在输入框内
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }

        // 快捷键: Ctrl + Alt + O
        if (e.ctrlKey && e.altKey && e.key === 'o') {
            e.preventDefault(); // 阻止浏览器默认行为
            toggleBionicReading();
        }
    });

    // 默认启动逻辑：在页面空闲时自动应用一次仿生阅读
    window.addEventListener('load', function() {
        if (isEnabled) {
            applyBionicReading();
            console.log("Bionic Reading 已在页面加载完成后默认启动。");
        }
    });

})();
